<% content_for :main_title do %><%= _("Player") %><% end %>

<%= javascript_include_jquery %>

<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.13.1/fc-4.2.1/datatables.min.css"/>
<script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.13.1/fc-4.2.1/datatables.min.js"></script>
<style>
table.dataTable thead tr th.dtfc-fixed-left, table.dataTable tfoot tr th.dtfc-fixed-left {
  background-color: #E3EFCA;
}
table.fixedHeader-floating {
  background-color: #E3EFCA;
}
table.dataTable tbody tr td.dtfc-fixed-left, table.dataTable thead tr th.dtfc-fixed-left {
  border-right: 1px solid rgba(0, 0, 0, 0.3);
}
table.dataTable tbody tr.even td.dtfc-fixed-left {
  background-color: #E3EFCA;
}
table.dataTable tbody tr.even {
  background-color: #E3EFCA;
}
table.dataTable tbody tr.even td.sorting_1 {
  background-color: #CEE3A3;
}
table.dataTable tbody tr.odd {
  background-color: #CEE3A3;
}
table.dataTable tbody tr.odd td.dtfc-fixed-left {
  background-color: #CEE3A3;
}

table.dataTable tbody tr.odd td.sorting_1 {
  background: #B9D77C;
}
div.dtfc-right-top-blocker {
  background-color: rgba(0, 0, 0, 0);
}
table {
  font-size: small;
}

td:nth-child(2) {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.championship_name {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
  width: 100%;
}

td:nth-child(n+4), th:nth-child(n+4) {
  text-align: right;
}
table.dataTable tfoot th {
  text-align: right;
}
#div_season_table {
  overflow: auto;
}
</style>

<h2><%= @player.name %> - <%= @player.full_name %></h2>
<div id='div_season_table'>
<table id="season_table">
  <thead>
    <tr>
      <th><%= _("Season") %></th>
      <th><%= _("Team") %></th>
      <th><%= _("Championship") %></th>
      <th title="<%= _("Minutes") %>"><%= s_("Minutes|M") %></th>
      <th title="<%= _("Goals") %>"><%= image_tag "goal.png" %></th>
      <th title="<%= _("Appearances") %>"><%= s_("Appearances|A") %></th>
      <th title="<%= _("Played") %>"><%= s_("Played|P") %></th>
      <th title="<%= _("Goals per 90 minutes") %>"><%= image_tag "goal.png", size: "8x8" %><span style="font-size: xx-small">/90</span></th>
      <th title="<%= _("Penalties") %>"><%= s_("Penalties|P") %></th>
      <th title="<%= _("Own Goals") %>"><%= s_("OwnGoals|O") %></th>
      <th title="<%= _("Yellows") %>"><%= image_tag "yells.gif" %></th>
      <th title="<%= _("Reds") %>"><%= image_tag "reds.gif" %></th>
    </tr>
  </thead>
  <tbody>
<% @player_stats.each do |p| %>
  <tr>
    <td data-order="<%= p.latest.to_i %>"><%= p.game.phase.championship.season %></td>
    <td class="ellipsis">
      <%= image_tag p.team.small_country_logo, title: _(p.team.country), size: "15x15", alt: "." %>
      <%= image_tag p.team.logo.url(:thumb), size: p.team.logo.styles[:thumb].geometry, alt: "." %>
      <%= link_to add_wbr_to_string(p.team.name), action: :team, controller: :championship, id: p.game.phase.championship, team: p.team %>
    </td>
    <td>
      <%= championship_name(p.game.phase.championship, false, false, {:controller => :championship, :action => :team, :id => p.game.phase.championship, team: p.team}) %>
    </td>
    <td><%= p.minutes %></td>
    <td><%= p.goals %></td>
    <td><%= p.appearances %></td>
    <td><%= p.played %></td>
    <td><%= number_with_precision(p.goals.to_f / (p.minutes.to_f.nonzero? || 1) * 90, precision: 2) %></td>
    <td><%= p.penalties %></td>
    <td><%= p.own_goals %></td>
    <td><%= p.yellows %></td>
    <td><%= p.reds %></td>
  </tr>
<% end %>
  </tbody>

<tfoot>
<tr>
  <th></th>
  <th></th>
  <th><%= _("Total") %></th>
   <th><%= @player_stats.map{|p|p.minutes}.sum %></th>
   <th><%= @player_stats.map{|p|p.goals}.sum %></th>
   <th><%= @player_stats.map{|p|p.appearances}.sum %></th>
   <th><%= @player_stats.map{|p|p.played}.sum %></th>
   <th><%= number_with_precision(@player_stats.map{|p|p.goals}.sum.to_f / (@player_stats.map{|p|p.minutes}.sum.nonzero? || 1) * 90, precision: 2) %></th>
   <th><%= @player_stats.map{|p|p.penalties}.sum %></th>
   <th><%= @player_stats.map{|p|p.own_goals}.sum %></th>
   <th><%= @player_stats.map{|p|p.yellows}.sum %></th>
   <th><%= @player_stats.map{|p|p.reds}.sum %></th>
</tr>
</tfoot>
</table>
</div>
<script>
jQuery(document).ready( function () {
  jQuery('#season_table').DataTable({
    language: { url: 'https://cdn.datatables.net/plug-ins/1.13.1/i18n/<%= I18n.locale %>.json' },
    fixedColumns: true,
    searching: false,
    info: false,
    paging: false,
    scrollY: 400,
    scrollCollapse: true,
    scrollX: true,
    order: [[ 0, 'desc' ]],
    columnDefs: [
        { targets: [0,3,4,5,6,7,8,9,10,11], orderSequence: ["desc", "asc"]},
    ],
  });
});
</script>

<h2> <%= link_to _("Games"), :action => :games, :id => @player, :type => :played %></h2>

<div class="game_score">
  <% last_championship = nil %>
<% @player.player_games.includes(game: { phase: :championship }).includes(game: [:home, :away]).includes(:team).order("games.date DESC").limit(10).each do |pg| %>
  <% if last_championship != pg.game.phase.championship %>
    <% last_championship = pg.game.phase.championship %>
    <%= championship_name(pg.game.phase.championship, {:controller => :championship, :action => :team, :id => pg.game.phase.championship, :team => pg.team}) %>
  <% end %>
  <div style='font-size: 11px'><%= formatted_date(pg.game, true) %></div>
  <div class="<%= cycle "table_line_even", "table_line_odd" %> table_row">
    <div class="table_cell" style="width: 92%">
      <%= render :partial => "championship/game_list",
                 :locals => { :highlight_team => pg.team,
                              :game => pg.game,
                              :show_country => pg.game.phase.championship.show_country,
                            } %>
      <div class="clearer"></div>
    </div>
    <div class="clearer"></div>
  </div>
  <%= render :partial => "player/game_detail", :locals => { :pg => pg } %>
<% end %>
</div>

<%= render :partial => "comment/comments", :locals => { :object => @player } %>

<% content_for :sidebar do %>
  <% if can? :manage, @player %>
    <%= link_to _("Edit"), :action => :edit, :id => @player %><br/>
    <%= link_to _("Delete"), { :action => :destroy, :id => @player }, :confirm => _('Are you sure?'), :method => :post %><br/>
    <br>
  <% end %>
  <%= link_to _("Player"), :action => :show, :id => @player %><br/>
  <%= link_to _("Games"), :action => :games, :id => @player, :type => :played %><br/>
<% end %>
